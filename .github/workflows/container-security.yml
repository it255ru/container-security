name: Dockerfile Line-by-Line Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  dockerfile-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Hadolint
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        format: json
        output-file: hadolint-results.json
      continue-on-error: true
      
    - name: Custom Dockerfile analysis
      run: |
        echo "## ðŸ“‹ Custom Dockerfile Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ð² Ð²Ð°ÑˆÐµÐ¼ Dockerfile
        echo "### ðŸ” ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ð² Ð²Ð°ÑˆÐµÐ¼ Dockerfile:" >> $GITHUB_STEP_SUMMARY
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° ADD Ð²Ð¼ÐµÑÑ‚Ð¾ COPY
        if grep -q "ADD" Dockerfile; then
          echo "â€¢ **WARNING**: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ ADD Ð²Ð¼ÐµÑÑ‚Ð¾ COPY. COPY Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ñ‡Ñ‚Ð¸Ñ‚ÐµÐ»ÑŒÐ½ÐµÐµ Ð´Ð»Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð²" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸
        if grep -q "node:14" Dockerfile; then
          echo "â€¢ **WARNING**: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ 'node:14'. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° curl | bash
        if grep -q "curl.*|.*bash" Dockerfile; then
          echo "â€¢ **CRITICAL**: ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½ Ð¾Ð¿Ð°ÑÐ½Ñ‹Ð¹ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½ 'curl | bash'. Ð­Ñ‚Ð¾ ÑƒÐ³Ñ€Ð¾Ð·Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸!" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² 777
        if grep -q "777" Dockerfile; then
          echo "â€¢ **CRITICAL**: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð¿Ñ€Ð°Ð²Ð° 777 - ÑÑ‚Ð¾ ÑÐµÑ€ÑŒÐµÐ·Ð½Ð°Ñ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸!" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° pinning Ð²ÐµÑ€ÑÐ¸Ð¹ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
        if grep -q "npm install" Dockerfile && ! grep -q "package-lock.json\|pnpm-lock.yaml" Dockerfile; then
          echo "â€¢ **WARNING**: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° npm Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð±ÐµÐ· Ñ„Ð¸ÐºÑÐ°Ñ†Ð¸Ð¸ Ð²ÐµÑ€ÑÐ¸Ð¹" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Display Hadolint results
      run: |
        if [ -f hadolint-results.json ]; then
          echo "### ðŸ³ Hadolint Detailed Results:" >> $GITHUB_STEP_SUMMARY
          jq -r '.[] | "â€¢ Line \(.line): \(.message) (ÐºÐ¾Ð´: \(.code))"' hadolint-results.json >> $GITHUB_STEP_SUMMARY
        fi
