name: Container Security Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security_audit:
    name: Container Security CI/CD Checklist
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t myapp:ci .

      # --- 1. Проверка базового образа и версии ---
      - name: Check Dockerfile best practices
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          format: json

      # --- 2. Сканирование уязвимостей в образе ---
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: myapp:ci
          format: table
          vuln-type: os,library
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          exit-code: 1

      # --- 3. Проверка зависимостей (SCA) ---
      - name: Software Composition Analysis (SCA)
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - run: |
          pip install safety
          safety check || true  # не прерываем билд, просто логируем

      # --- 4. Проверка RBAC и политик ---
      - name: Validate Kubernetes manifests (если есть)
        if: hashFiles('k8s/**/*.yaml') != ''
        uses: instrumenta/kubeval-action@v1.0.0
        with:
          files: k8s/**/*.yaml

      # --- 5. Проверка подписей и SBOM ---
      - name: Generate and verify SBOM
        uses: anchore/syft-action@v0.16.0
        with:
          image: myapp:ci
          output: sbom.json
      - name: Verify SBOM signature
        run: |
          echo "SBOM generated. Ensure signing and verification policy applied."

      # --- 6. Итоговый отчёт ---
      - name: Summary Report
        run: |
          echo "[V] Container security CI/CD checklist complete."
          echo "Check artifacts and logs for details."

      - name: Validate checklist status
        run: |
          echo "Checking checklist..."
          missing=$(grep "☐" checklist.csv || true)
          if [ -n "$missing" ]; then
            echo "[X] There are unchecked security tasks:"
            echo "$missing"
            exit 1
          else
            echo "[V] All checklist items completed."
          fi
