name: Dockerfile Security Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  dockerfile_audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Hadolint ---
      - name: Hadolint Lint
        run: |
          echo "üîπ Checking Dockerfile with Hadolint..."
          hadolint Dockerfile -f json | jq -r '.[] | "Line \(.line): \(.code) - \(.message)"' > hadolint-report.txt
          if [ -s hadolint-report.txt ]; then
            echo "‚ùå Hadolint found issues:"
            cat hadolint-report.txt
          else
            echo "‚úÖ No Hadolint issues found."
          fi

      # --- Build Docker image for Trivy ---
      - name: Build Docker image
        run: docker build -t student-app:ci .

      # --- Trivy scan ---
      - name: Trivy Vulnerability Scan
        run: |
          echo "üîπ Scanning Docker image with Trivy..."
          trivy image --ignore-unfixed --severity CRITICAL,HIGH --format table student-app:ci > trivy-report.txt || true
          if [ -s trivy-report.txt ]; then
            echo "‚ùå Trivy found vulnerabilities:"
            cat trivy-report.txt
          else
            echo "‚úÖ No critical/high vulnerabilities found."
          fi

      # --- Summary ---
      - name: Summary
        run: |
          echo "-----------------------------"
          echo "Dockerfile Audit Completed"
          echo "Hadolint issues:"
          [ -f hadolint-report.txt ] && cat hadolint-report.txt || echo "None"
          echo "Trivy vulnerabilities:"
          [ -f trivy-report.txt ] && cat trivy-report.txt || echo "None"
          echo "-----------------------------"
