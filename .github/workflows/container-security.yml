name: Dockerfile Security Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  dockerfile_audit:
    runs-on: ubuntu-latest

    steps:
      # --- 0. Checkout repository ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- 1. Hadolint Lint ---
      - name: Dockerfile Lint (Hadolint)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          format: json

      # --- 1a. Format Hadolint output for students ---
      - name: Hadolint Summary
        run: |
          echo "üîπ Hadolint summary:"
          if [ -f Dockerfile ]; then
            hadolint Dockerfile -f json | jq -r '.[] | "Line \(.line): \(.code) - \(.message)"' || echo "‚úÖ No issues found"
          else
            echo "‚ö†Ô∏è Dockerfile not found"
          fi

      # --- 2. Build Docker image ---
      - name: Build Docker image
        run: docker build -t student-app:ci .

      # --- 3. Trivy Vulnerability Scan ---
      - name: Trivy Vulnerability Scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: student-app:ci
          format: table
          severity: CRITICAL,HIGH
          ignore-unfixed: true

      # --- 4. Final Summary ---
      - name: Summary
        run: |
          echo "-----------------------------"
          echo "Dockerfile Audit Completed"
          echo "Check Hadolint summary above for Dockerfile issues."
          echo "Check Trivy output above for vulnerabilities."
          echo "-----------------------------"
