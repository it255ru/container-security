name: Dockerfile Security Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  dockerfile_audit:
    runs-on: ubuntu-latest

    steps:
      # --- 0. Checkout repository ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- 1. Hadolint Lint ---
      - name: Hadolint Lint
        run: |
          echo "üîπ Checking Dockerfile with Hadolint..."
          # –í—ã–≤–æ–¥–∏–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –∫–æ—Ä–æ—Ç–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
          hadolint Dockerfile -f json | jq -r '.[] | "Line \(.line): \(.code) - \(.message)"' > hadolint-report.txt || true
          if [ -s hadolint-report.txt ]; then
            echo "‚ùå Hadolint found issues:"
            cat hadolint-report.txt
          else
            echo "‚úÖ No Hadolint issues found."
          fi

      # --- 2. Build Docker image ---
      - name: Build Docker image
        run: docker build -t student-app:ci .

      # --- 3. Trivy Vulnerability Scan ---
      - name: Trivy Vulnerability Scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: student-app:ci
          format: table
          severity: CRITICAL,HIGH
          ignore-unfixed: true

      # --- 4. Summary ---
      - name: Summary
        run: |
          echo "-----------------------------"
          echo "Dockerfile Audit Completed"
          echo "Hadolint issues:"
          [ -f hadolint-report.txt ] && cat hadolint-report.txt || echo "None"
          echo "Trivy scan output above."
          echo "-----------------------------"
