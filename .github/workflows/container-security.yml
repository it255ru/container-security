name: Container Security Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security_audit:
    name: Container Security CI/CD Checklist
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      # --- 0. Checkout ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- 1. Setup Docker ---
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t myapp:ci .

      # --- 2. Проверка Dockerfile (lint) ---
      - name: Dockerfile Lint (Hadolint)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          format: tty

      # --- 2a. Авто-обновление checklist с любыми предупреждениями Hadolint ---
      - name: Update checklist with Hadolint warnings
        working-directory: ./  # корень репозитория, где находится Dockerfile и checklist.csv
        run: |
          # Проверяем, существует ли checklist.csv, если нет — создаём
          if [ ! -f checklist.csv ]; then
            echo "Checklist" > checklist.csv
          fi
      
          # Записываем вывод Hadolint во временный файл
          hadolint Dockerfile > hadolint-output.txt || true
      
          # Если есть предупреждения
          if [ -s hadolint-output.txt ]; then
            echo "Processing Hadolint warnings into checklist.csv..."
            while read -r line; do
              code=$(echo "$line" | awk '{print $1}')
              # Добавляем только если такого кода ещё нет
              if ! grep -q "$code" checklist.csv; then
                echo "☐ $line" >> checklist.csv
              fi
            done < hadolint-output.txt
          else
            echo "No Hadolint warnings found."
          fi

      # --- 3. Сканирование уязвимостей ---
      - name: Vulnerability Scan (Trivy)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: myapp:ci
          format: sarif
          output: trivy-results.sarif
          ignore-unfixed: true
          vuln-type: os,library
          severity: CRITICAL,HIGH
          exit-code: 1

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif

      # --- 4. Анализ зависимостей (SCA) ---
      - name: Software Composition Analysis
        uses: pypa/gh-action-pip-audit@v1.1.0
        with:
          requirements: requirements.txt
          format: json
        continue-on-error: true

      # --- 5. Генерация SBOM (Syft) ---
      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          image: myapp:ci
          output-file: sbom.json

      # --- 6. Проверка чеклиста (checklist.csv) ---
      - name: Validate checklist status
        run: |
          echo "Checking checklist..."
          if grep -q "☐" checklist.csv; then
            echo "❌ There are unchecked security tasks:"
            grep "☐" checklist.csv
            exit 1
          else
            echo "✅ All checklist items completed."
          fi

      # --- 7. Финальный отчёт ---
      - name: Summary
        run: |
          echo "✅ Container Security Audit completed successfully."
